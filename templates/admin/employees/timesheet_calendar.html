{% load i18n static %}
<!--
Template: timesheet_calendar.html
Version: 1.0.0
Author: vas
Modified: 2025-11-27
-->

<link rel="stylesheet" href="{% static 'employees/timesheet.css' %}">
<div class="ts-card-{{ cal_type }}">
  <div class="ts-head">
    <div class="ts-title">{{ month_label }} <span class="ts-meta">üéõÔ∏è MR. CALENDAR v1</span></div>
  </div>

  <div class="ts-weekday-row">
    {% for lbl in weekday_labels %}
      <div>{{ lbl }}</div>
    {% endfor %}
  </div>

  <div class="ts-grid">
    {% for c in cells %}
      {% if c.spacer %}
        <div class="ts-cell ts-spacer" aria-hidden="true"></div>
      {% else %}
        <div class="ts-cell ts-{{ c.kind_class }}{% if c.is_today %} ts-today{% endif %}">
          <div class="ts-dayhead">
            <span class="ts-daynum">{{ c.date|date:"j" }}</span>
            {% if not c.is_holiday and not is_locked %}
              <a class="ts-add related-widget-wrapper-link"
                 data-popup="yes"
                 onclick="return showAddAnotherPopup(this);"
                 href="{{ add_url_base }}&timesheet={{ timesheet_id }}&date={{ c.date|date:'Y-m-d' }}&_popup=1&next={{ ts_change_url|urlencode }}"
                 title="{% trans 'Add entry' %}">+</a>
            {% else %}
              <span class="ts-add ts-add-disabled" title="{% trans 'No entry' %}">‚Äî</span>
            {% endif %}
          </div>

          {% if c.items %}
            <ul class="ts-chips">
              {% for it in c.items %}
                <li class="chip k-{{ it.kind|lower }}">
                  <a class="related-widget-wrapper-link chip-edit-link"
                     data-popup="yes"
                     onclick="return showAddAnotherPopup(this);"
                     title="{% if it.comment %}{{ it.comment }}{% else %}{% trans 'Edit entry' %}{% endif %}"
                     href="{% url 'admin:employees_timeentry_change' it.id %}?_popup=1&next={{ ts_change_url|urlencode }}">
                    <span class="txt">{% if it.minutes %}{{ it.minutes }}m{% endif %}</span><br>
                    {% if it.comment %}<span class="cmt">{{ it.comment }}</span>{% endif %}
                  </a>
                  {% if not is_locked %}
                  <button class="chip-delete-btn" 
                          type="button"
                          data-entry-id="{{ it.id }}"
                          data-ts-url="{{ ts_change_url }}"
                          onclick="deleteTimeEntry(this)"
                          title="{% trans 'Delete entry' %}">√ó</button>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="ts-legend">
    {% if cal_type == "wrk" %}
    <span class="chip chip-work">{% trans "Work" %}</span>
    <span class="chip chip-other">{% trans "Other" %}</span>
    <span class="chip chip-holiday">{% trans "Holiday" %}</span>
    {% elif cal_type == "pto" %}
    <span class="chip chip-leave">{% trans "Leave" %}</span>
    <span class="chip chip-sick">{% trans "Sick" %}</span>
    <span class="chip chip-holiday">{% trans "Holiday" %}</span>
    {% endif %}
  </div>
</div>

<script>
function deleteTimeEntry(btn) {
  const entryId = btn.getAttribute('data-entry-id');
  const tsUrl = btn.getAttribute('data-ts-url');
  
  if (!confirm('{% trans "Delete this time entry?" %}')) {
    return;
  }

  // Django admin delete requires POST with confirmation
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/admin/employees/timeentry/${entryId}/delete/`;
  
  // CSRF token
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = getCookie('csrftoken');
  form.appendChild(csrfInput);
  
  // Confirmation input (Django admin requires this)
  const confirmInput = document.createElement('input');
  confirmInput.type = 'hidden';
  confirmInput.name = 'post';
  confirmInput.value = 'yes';
  form.appendChild(confirmInput);
  
  document.body.appendChild(form);
  
  // Submit form, then reload page
  fetch(form.action, {
    method: 'POST',
    body: new FormData(form),
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  }).then(response => {
    if (response.ok || response.redirected) {
      // Reload the timesheet page to reflect deletion
      window.location.href = tsUrl;
    } else {
      alert('{% trans "Failed to delete entry. Please try again." %}');
    }
  }).catch(err => {
    console.error('Delete error:', err);
    alert('{% trans "Failed to delete entry. Please try again." %}');
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>