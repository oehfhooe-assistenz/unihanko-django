{% extends "portal/base.html" %}
{% load i18n %}

{% block content %}
<h1 class="page-title">{% trans "ECTS Request Status" %}</h1>

<div class="card">
    <h2 class="card-title">{{ inbox_request.semester.display_name }}</h2>
    <p class="text-muted">
        {% trans "Welcome" %}, {{ inbox_request.person_role.person.first_name }} {{ inbox_request.person_role.person.last_name }}
    </p>
</div>

<div class="card payment-plan-card" data-request-id="{{ inbox_request.id }}" data-reference="{{ inbox_request.reference_code }}">
    <!-- Request Header -->
    <div class="plan-header">
        <div>
            <h3 class="card-title mb-1">{{ inbox_request.reference_code }}</h3>
            <div class="plan-info-grid">
                <div class="info-item">
                    <p class="info-label">{% trans "Role" %}</p>
                    <p class="info-value">{{ inbox_request.person_role.role.name }}</p>
                </div>
                <div class="info-item">
                    <p class="info-label">{% trans "Total ECTS" %}</p>
                    <p class="info-value highlight">{{ total_ects }} ECTS</p>
                </div>
                <div class="info-item">
                    <p class="info-label">{% trans "Stage" %}</p>
                    {% include "portal/includes/stage_progress.html" with current_stage=stage stage_type="ects" %}
                </div>
            </div>
        </div>
        <div class="plan-actions">
            {% if stage in 'VERIFIED,APPROVED,REJECTED,TRANSFERRED' %}
                <a href="{% url 'portal:academia:request_pdf' reference_code=inbox_request.reference_code %}" 
                   class="btn btn-small" target="_blank">
                    üìÑ {% trans "RECEIPT" %}
                </a>
            {% endif %}
            
            {% if stage in 'DRAFT,SUBMITTED' %}
                <button class="btn btn-small toggle-btn" 
                        data-target="form-{{ inbox_request.id }}" 
                        data-text-complete="‚öôÔ∏è {% trans 'Complete' %}"
                        data-text-cancel="‚ùå {% trans 'Cancel' %}">
                    ‚öôÔ∏è {% trans "Complete" %}
                </button>
            {% else %}
                <button class="btn btn-secondary btn-small toggle-btn" 
                        data-target="details-{{ inbox_request.id }}"
                        data-text-details="üëÅÔ∏è {% trans 'Details' %}"
                        data-text-close="‚ùå {% trans 'Close' %}">
                    üëÅÔ∏è {% trans "Details" %}
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Collapsible Content for DRAFT/SUBMITTED -->
    {% if stage in 'DRAFT,SUBMITTED' %}
    <div id="form-{{ inbox_request.id }}" class="collapsible-content hidden">
        <div class="scrollable-accordion">
            
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step-indicator step-filed completed">
                    <span class="step-number">‚úì</span>
                    <span class="step-text">{% trans "Filed" %}</span>
                </div>
                <div class="step-connector"></div>
                <div class="step-indicator step-upload {{ inbox_request.uploaded_form|yesno:'completed,active' }}">
                    <span class="step-number">2</span>
                    <span class="step-text">{% trans "Upload Form" %}</span>
                </div>
                <div class="step-connector"></div>
                <div class="step-indicator step-processing {{ inbox_request.uploaded_form|yesno:'active,pending' }}">
                    <span class="step-number">3</span>
                    <span class="step-text">{% trans "Processing" %}</span>
                </div>
            </div>

            <!-- Request Summary -->
            <div class="form-section-compact">
                <h4 class="form-section-title">
                    ‚úÖ {% trans "Request Summary" %}
                </h4>
                
                <div class="info-summary">
                    <p><strong>{{ inbox_request.person_role.person.first_name }} {{ inbox_request.person_role.person.last_name }}</strong></p>
                    <p>{{ inbox_request.person_role.role.name }}</p>
                    <p>{% trans "Filed" %}: {{ inbox_request.created_at|date:"d.m.Y H:i" }}</p>
                </div>

                <h5 class="mt-2 mb-1">{% trans "Courses" %}</h5>
                <div class="courses-summary">
                    {% for course in inbox_request.courses.all %}
                    <div class="course-list-item">
                        <span>
                            {% if course.course_code %}{{ course.course_code }}{% endif %}
                            {% if course.course_code and course.course_name %} - {% endif %}
                            {% if course.course_name %}{{ course.course_name }}{% endif %}
                        </span>
                        <span class="highlight">{{ course.ects_amount }} ECTS</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- ECTS Breakdown -->
                <div class="ects-breakdown">
                    <div class="ects-row">
                        <span>{% trans "Your Total ECTS" %}:</span>
                        <strong>{{ total_ects }}</strong>
                    </div>
                    <div class="ects-row">
                        <span>{% trans "Role Entitlement" %}:</span>
                        <strong>{{ inbox_request.person_role.role.ects_cap }}</strong>
                    </div>
                    <div class="ects-row">
                        <span>{% trans "Semester Adjustment" %}:</span>
                        <strong>{{ inbox_request.semester.ects_adjustment|stringformat:"+.1f" }}</strong>
                    </div>
                    <div class="ects-row total-row">
                        <span>{% trans "Max Entitled" %}:</span>
                        <strong>{{ max_ects }}</strong>
                    </div>
                </div>

                {% if inbox_request.student_note %}
                <div class="mt-2">
                    <p class="info-label">{% trans "Your Note" %}</p>
                    <p>{{ inbox_request.student_note }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Download PDF Section -->
            <div class="form-section-compact">
                <h4 class="form-section-title">
                    üìÑ {% trans "Download Form for Signatures" %}
                </h4>
                <p class="help-text mb-2">
                    1. {% trans "Download your PDF form below" %}<br>
                    2. {% trans "Get it signed by both your lecturer and yourself (handwritten or electronic)" %}<br>
                    3. {% trans "Upload the twice-signed version below" %}
                </p>
                
                <div class="mb-2">
                    <a href="{% url 'portal:academia:request_pdf' reference_code=inbox_request.reference_code %}" 
                       class="btn btn-secondary btn-small" target="_blank">
                        üì• {% trans "Download Form (Blank)" %}
                    </a>
                </div>
            </div>

            <!-- Upload Section -->
            {% if not inbox_request.uploaded_form %}
            <div class="form-section-compact">
                <h4 class="form-section-title">
                    üì§ {% trans "Upload Signed Form" %}
                </h4>

                {% if affidavit_2 %}
                <div class="disclaimer-text">
                    <h5>{% trans "Upload Declaration" %}</h5>
                    <p>{{ affidavit_2|linebreaks }}</p>
                </div>

                <div class="form-group-compact">
                    <label class="checkbox-label">
                        <input type="checkbox" id="affidavit2-{{ inbox_request.id }}" required class="checkbox-input">
                        <span class="checkbox-text">
                            <strong>{% trans "I confirm the above statement" %}</strong>
                        </span>
                    </label>
                </div>
                {% endif %}
                
                <form method="post" enctype="multipart/form-data" id="upload-form-{{ inbox_request.id }}">
                    {% csrf_token %}
                    
                    <div class="form-grid-compact">
                        <div class="form-group-compact">
                            <label class="form-label-compact">{% trans "Signed PDF File" %}</label>
                            {{ upload_form.uploaded_form }}
                            {% if upload_form.uploaded_form.errors %}
                                <ul class="errorlist">
                                    {% for error in upload_form.uploaded_form.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                            <span class="form-help">{% trans "Make sure all signatures are present (max 20MB)" %}</span>
                        </div>
                    </div>
                    
                    <div class="form-actions-compact">
                        <button type="submit" class="btn btn-small" id="upload-btn-{{ inbox_request.id }}" disabled>
                            üì§ {% trans "Submit Signed Form" %}
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="form-section-compact">
                <h4 class="form-section-title">
                    ‚úÖ {% trans "Form Uploaded Successfully" %}
                </h4>
                <div class="info-summary">
                    <p>{% trans "Your signed form has been uploaded and is being processed by our team." %}</p>
                    <p>{% trans "Uploaded" %}: {{ inbox_request.uploaded_form_at|date:"d.m.Y H:i" }}</p>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
    {% endif %}

    <!-- Collapsible Content for Completed Stages -->
    {% if stage not in 'DRAFT,SUBMITTED' %}
    <div id="details-{{ inbox_request.id }}" class="collapsible-content hidden">
        <div class="scrollable-accordion">
            
            <!-- Status Info -->
            <div class="form-section-compact">
                <h4 class="form-section-title">{% trans "Request Information" %}</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <p class="info-label">{% trans "Person" %}</p>
                        <p class="info-value">{{ inbox_request.person_role.person.first_name }} {{ inbox_request.person_role.person.last_name }}</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">{% trans "Role" %}</p>
                        <p class="info-value">{{ inbox_request.person_role.role.name }}</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">{% trans "Filed" %}</p>
                        <p class="info-value">{{ inbox_request.created_at|date:"d.m.Y" }}</p>
                    </div>
                    {% if inbox_request.uploaded_form_at %}
                    <div class="info-item">
                        <p class="info-label">{% trans "Form Submitted" %}</p>
                        <p class="info-value">{{ inbox_request.uploaded_form_at|date:"d.m.Y" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Course Details -->
            <div class="form-section-compact">
                <h4 class="form-section-title">{% trans "Course Details" %}</h4>
                <div class="courses-summary">
                    {% for course in inbox_request.courses.all %}
                    <div class="course-list-item">
                        <div>
                            <strong>
                                {% if course.course_code %}{{ course.course_code }}{% endif %}
                                {% if course.course_code and course.course_name %} - {% endif %}
                                {% if course.course_name %}{{ course.course_name }}{% endif %}
                            </strong>
                        </div>
                        <span class="highlight">{{ course.ects_amount }} ECTS</span>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- ECTS Breakdown -->
                <div class="ects-breakdown mt-2">
                    <div class="ects-row">
                        <span>{% trans "Your Total ECTS" %}:</span>
                        <strong>{{ total_ects }}</strong>
                    </div>
                    <div class="ects-row">
                        <span>{% trans "Role Entitlement" %}:</span>
                        <strong>{{ inbox_request.person_role.role.ects_cap }}</strong>
                    </div>
                    <div class="ects-row">
                        <span>{% trans "Semester Adjustment" %}:</span>
                        <strong>{{ inbox_request.semester.ects_adjustment|stringformat:"+.1f" }}</strong>
                    </div>
                    <div class="ects-row total-row">
                        <span>{% trans "Max Entitled" %}:</span>
                        <strong>{{ max_ects }}</strong>
                    </div>
                </div>
            </div>

            <!-- Documents -->
            <div class="form-section-compact">
                <h4 class="form-section-title">{% trans "Documents" %}</h4>
                <div class="form-actions-compact">
                    <a href="{% url 'portal:academia:request_pdf' reference_code=inbox_request.reference_code %}" 
                       class="btn btn-small" target="_blank">
                        üìÑ {% trans "Download Request Form" %}
                    </a>
                    {% if inbox_request.uploaded_form %}
                    <a href="{{ inbox_request.uploaded_form.url }}" 
                       class="btn btn-secondary btn-small" target="_blank">
                        üìé {% trans "View Signed Form" %}
                    </a>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
    {% endif %}
</div>

<!-- Quick Reference Copy -->
<div class="card">
    <h4 class="card-title">{% trans "Your Reference Code" %}</h4>
    <div class="reference-code-box">
        <input type="text" 
               value="{{ inbox_request.reference_code }}" 
               readonly 
               class="reference-code-input"
               id="reference-code-input">
        <button class="btn btn-small copy-btn" 
                onclick="copyReferenceCode()" 
                id="copy-btn">
            üìã {% trans "Copy" %}
        </button>
    </div>
    <p class="help-text mt-1">
        {% trans "Save this code to check your request status or upload documents later." %}
    </p>
</div>

<div class="mt-3">
    <a href="{% url 'portal:academia:semester_list' %}" class="btn btn-secondary">
        ‚Üê {% trans "Back to Semesters" %}
    </a>
</div>

{% endblock %}

{% block extra_js %}
<script>
function copyReferenceCode() {
    const input = document.getElementById('reference-code-input');
    const btn = document.getElementById('copy-btn');
    
    input.select();
    input.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(input.value).then(function() {
        const originalText = btn.textContent;
        btn.textContent = '‚úì {% trans "Copied!" %}';
        setTimeout(function() {
            btn.textContent = originalText;
        }, 2000);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle accordion toggles
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);
            
            if (!target) return;
            
            const isHidden = target.classList.contains('hidden');
            
            if (isHidden) {
                target.classList.remove('hidden');
                target.classList.add('show');
                this.classList.add('active');
                
                const cancelText = this.getAttribute('data-text-cancel') || '‚ùå {% trans "Cancel" %}';
                const closeText = this.getAttribute('data-text-close') || '‚ùå {% trans "Close" %}';
                this.textContent = cancelText || closeText;
            } else {
                target.classList.add('hidden');
                target.classList.remove('show');
                this.classList.remove('active');
                
                const completeText = this.getAttribute('data-text-complete') || '‚öôÔ∏è {% trans "Complete" %}';
                const detailsText = this.getAttribute('data-text-details') || 'üëÅÔ∏è {% trans "Details" %}';
                this.textContent = completeText || detailsText;
            }
        });
    });

    // Handle affidavit checkbox
    document.querySelectorAll('[id^="affidavit2-"]').forEach(checkbox => {
        const requestId = checkbox.id.split('-')[1];
        const uploadBtn = document.getElementById(`upload-btn-${requestId}`);
        
        if (uploadBtn) {
            checkbox.addEventListener('change', function() {
                uploadBtn.disabled = !this.checked;
            });
        }
    });
});
</script>
{% endblock %}