{% extends "portal/base.html" %}
{% load i18n %}

<!--
Template: file_request.html
Version: 1.0.0
Author: vas
Modified: 2025-11-27
-->

{% block content %}
<h1 class="page-title">{% trans "File ECTS Request" %}</h1>

<div class="card">
    <h2 class="card-title">{{ semester.display_name }}</h2>
    <p class="text-muted">
        {% trans "Filing Period" %}: {{ semester.filing_start|date:"d.m.Y" }} - {{ semester.filing_end|date:"d.m.Y" %}
    </p>
</div>

<form method="post" id="ects-filing-form">
    {% csrf_token %}
    
    <div class="card">
        <!-- Step 1: Person Role Selection -->
        <div class="form-section-compact">
            <h4 class="form-section-title">
                ðŸ“‹ {% trans "Select Your Role" %}
            </h4>
            
            <div class="form-group-compact">
                <label class="form-label-compact">{{ form.person_role.label }}</label>
                {{ form.person_role }}
                {% if form.person_role.errors %}
                    <ul class="errorlist">
                        {% for error in form.person_role.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
                {% if form.person_role.help_text %}
                    <span class="form-help">{{ form.person_role.help_text }}</span>
                {% endif %}
            </div>

            <div class="form-group-compact">
                <label class="form-label-compact">{{ form.student_note.label }}</label>
                {{ form.student_note }}
                {% if form.student_note.errors %}
                    <ul class="errorlist">
                        {% for error in form.student_note.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
                {% if form.student_note.help_text %}
                    <span class="form-help">{{ form.student_note.help_text }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Step 2: Course Entry -->
        <div class="form-section-compact">
            <h4 class="form-section-title">
                ðŸ“š {% trans "Add Your Courses" %} <span class="course-counter">(0/6)</span>
            </h4>
            
            <p class="help-text mb-2">
                {% trans "Add up to 6 courses. Each course needs a code OR name, plus ECTS amount." %}
            </p>

            <div class="courses-container">
                {{ course_formset.management_form }}
                {% for course_form in course_formset %}
                <div class="course-entry" data-course-index="{{ forloop.counter0 }}">
                    <div class="course-entry-header">
                        <h5 class="course-title">{% trans "Course" %} {{ forloop.counter }}</h5>
                    </div>
                    
                    <div class="form-grid-compact">
                        <div class="form-group-compact">
                            <label class="form-label-compact">{{ course_form.course_code.label }}</label>
                            {{ course_form.course_code }}
                        </div>
                        <div class="form-group-compact">
                            <label class="form-label-compact">{{ course_form.course_name.label }}</label>
                            {{ course_form.course_name }}
                        </div>
                        <div class="form-group-compact">
                            <label class="form-label-compact">{{ course_form.ects_amount.label }}</label>
                            {{ course_form.ects_amount }}
                            {% if course_form.ects_amount.help_text %}
                                <span class="form-help">{{ course_form.ects_amount.help_text }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="courses-summary">
                <p><strong>{% trans "Total ECTS" %}:</strong> <span id="total-ects-display">0.0</span></p>
            </div>
        </div>

        <!-- Step 3: Affidavit -->
        <div class="form-section-compact">
            <h4 class="form-section-title">
                âœ… {% trans "Confirmation" %}
            </h4>

            {% if affidavit_1 %}
            <div class="disclaimer-text">
                <h5>{% trans "Affidavit" %}</h5>
                <p>{{ affidavit_1|linebreaks }}</p>
            </div>

            <div class="form-group-compact">
                <label class="checkbox-label">
                    {{ form.affidavit1_confirmed }}
                    <span class="checkbox-text">
                        <strong>{% trans "I confirm the above statement" %}</strong>
                    </span>
                </label>
                {% if form.affidavit1_confirmed.errors %}
                    <ul class="errorlist">
                        {% for error in form.affidavit1_confirmed.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Submit -->
        <div class="form-actions-compact">
            <button type="submit" class="btn" id="submit-btn">
                âœ… {% trans "Submit Request" %}
            </button>
        </div>

        <p class="help-text mt-2">
            {% trans "After submitting, you'll receive a reference code. Use it to download your form, get signatures, and upload the signed version." %}
        </p>
    </div>
</form>

<div class="mt-3">
    <a href="{% url 'portal:academia:semester_list' %}" class="btn btn-secondary">
        {% trans "Back to the ECTS Reimbursement Center" %}
    </a>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate total ECTS
    function calculateTotalEcts() {
        let total = 0;
        document.querySelectorAll('input[name$="-ects_amount"]').forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        document.getElementById('total-ects-display').textContent = total.toFixed(1);
        
        // Update course counter
        const filledCourses = Array.from(document.querySelectorAll('input[name$="-ects_amount"]'))
            .filter(input => parseFloat(input.value) > 0).length;
        
        document.querySelector('.course-counter').textContent = `(${filledCourses}/6)`;
        
        return total;
    }

    // Course input listeners
    document.querySelectorAll('input[name$="-ects_amount"]').forEach(input => {
        input.addEventListener('input', calculateTotalEcts);
    });

    // Initialize
    calculateTotalEcts();
});
</script>
{% endblock %}