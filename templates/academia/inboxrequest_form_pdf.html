{% extends "pdf/base.html" %}
{% load i18n %}

{% block header_title %}{% trans "ECTS Reimbursement Request" %} — {{ request.reference_code }}{% endblock %}

{% block content %}
{% include '_includes/_org_header.html' with org=org %}

<h1 class="document-title">{% trans "ECTS Reimbursement Request Form" %}</h1>
<p class="document-code">{{ request.reference_code }}</p>

<div class="section">
    <h2 class="section-title">{% trans "Request Details" %}</h2>
    <div class="section-content">
        <table class="info-table">
            <tr>
                <th>{% trans "Reference Code" %}</th>
                <td><strong>{{ request.reference_code }}</strong></td>
            </tr>
            <tr>
                <th>{% trans "Semester" %}</th>
                <td>{{ request.semester.code }} — {{ request.semester.label }}</td>
            </tr>
            <tr>
                <th>{% trans "Person" %}</th>
                <td>{{ request.person.first_name }} {{ request.person.last_name }}</td>
            </tr>
            <tr>
                <th>{% trans "Submission Date" %}</th>
                <td>{{ request.created_at|date:"d.m.Y H:i" }}</td>
            </tr>
            <tr>
                <th>{% trans "Status" %}</th>
                <td>{{ request.get_stage_display }}</td>
            </tr>
        </table>
    </div>
</div>

<div class="section">
    <h2 class="section-title">{% trans "Course List" %}</h2>
    <div class="section-content">
        <table class="data-table">
            <thead>
                <tr>
                    <th>{% trans "Course Code" %}</th>
                    <th>{% trans "Course Name" %}</th>
                    <th class="text-right">{% trans "ECTS" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for course in request.courses.all %}
                <tr>
                    <td>{{ course.course_code|default:"—" }}</td>
                    <td>{{ course.course_name|default:"—" }}</td>
                    <td class="text-right">{{ course.ects|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center">{% trans "No courses listed" %}</td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td colspan="2" class="text-right"><strong>{% trans "Total ECTS" %}</strong></td>
                    <td class="text-right"><strong>{{ request.total_ects|floatformat:2 }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="section">
    <h2 class="section-title">{% trans "Eligibility" %}</h2>
    <div class="section-content">
        <table class="info-table">
            <tr>
                <th>{% trans "Person Roles" %}</th>
                <td>
                    {% for pr in request.person.person_roles.all %}
                        {% if pr.role.is_eligible_for_ects %}
                            {{ pr.role.name }}
                            ({% include '_includes/_date_period.html' with start_date=pr.start_date end_date=pr.end_date %})
                            — {% trans "Max" %} {{ pr.role.max_ects_per_semester }} {% trans "ECTS/semester" %}
                            {% if not forloop.last %}<br>{% endif %}
                        {% endif %}
                    {% empty %}
                        {% trans "No eligible roles found" %}
                    {% endfor %}
                </td>
            </tr>
        </table>
    </div>
</div>

<div class="section">
    <h2 class="section-title">{% trans "Affidavits" %}</h2>
    <div class="section-content">
        <div class="affidavit-box">
            <h4>{% trans "Initial Submission Affidavit" %}</h4>
            <p>{{ org.ects_affidavit_1|linebreaksbr|default:"—" }}</p>
            <p class="signature-line">
                <label>{% trans "Confirmed" %}:</label>
                {% if request.affidavit_1_at %}
                    {{ request.affidavit_1_at|date:"d.m.Y H:i" }}
                {% else %}
                    {% trans "Not confirmed" %}
                {% endif %}
            </p>
        </div>

        <div class="affidavit-box">
            <h4>{% trans "Form Upload Affidavit" %}</h4>
            <p>{{ org.ects_affidavit_2|linebreaksbr|default:"—" }}</p>
            <p class="signature-line">
                <label>{% trans "Confirmed" %}:</label>
                {% if request.affidavit_2_at %}
                    {{ request.affidavit_2_at|date:"d.m.Y H:i" }}
                {% else %}
                    {% trans "Not confirmed" %}
                {% endif %}
            </p>
        </div>
    </div>
</div>

{% if request.signed_form %}
<div class="section">
    <h2 class="section-title">{% trans "Uploaded Form" %}</h2>
    <div class="section-content">
        <table class="info-table">
            <tr>
                <th>{% trans "File" %}</th>
                <td>{{ request.signed_form.name }}</td>
            </tr>
            <tr>
                <th>{% trans "Upload Date" %}</th>
                <td>{{ request.form_uploaded_at|date:"d.m.Y H:i"|default:"—" }}</td>
            </tr>
        </table>
    </div>
</div>
{% endif %}

{% if request.notes %}
<div class="section">
    <h2 class="section-title">{% trans "Notes" %}</h2>
    <div class="section-content">
        <p>{{ request.notes|linebreaksbr }}</p>
    </div>
</div>
{% endif %}

{% include '_includes/_signature_seal.html' with signatures=signatures %}

{% include '_includes/_signature_boxes.html' with count=2 signers=signers %}

{% include '_includes/_disclaimer.html' %}

{% endblock %}
