{% extends "pdf/base.html" %}
{% load static i18n tz %}

{% block extra_styles %}
/* Protocol-specific styling */
@page {
    size: A4;
    margin: 30mm 15mm 20mm 15mm;
    @top-center { content: element(protocol-header); }
    @bottom-left { content: element(protocol-footer); }
    @bottom-right { content: "Seite " counter(page) " von " counter(pages); }
}

@page:first {
    margin-top: 0mm;
    @top-center { content: none; }
    @bottom-left { content: element(protocol-footer); }
}

/* Hide standard headers on protocols */
.header-hero, .header-std {
    display: none !important;
}

main {
    margin-top: 0 !important;
}

/* Running headers */
.protocol-header {
    position: running(protocol-header);
    border-bottom: 2px solid var(--brand);
    padding-bottom: 6px;
    font-size: 14px;
    text-align: center;
}

.protocol-footer {
    position: running(protocol-footer);
    border-top: 1px solid var(--rule);
    padding-top: 4px;
    font-size: 9px;
    color: var(--muted);
}

/* Protocol masthead (first page only) */
.protocol-masthead {
    background: var(--brand);
    color: var(--ink);
    margin-left: -15mm;
    margin-right: -15mm;
    padding: 12mm 15mm 8mm 15mm;
    margin-bottom: 8mm;
}

.protocol-masthead h1 {
    font-size: 24px;
    font-weight: 800;
    margin: 0;
}

.protocol-masthead .subtitle {
    font-size: 16px;
    font-weight: 700;
    margin-top: 2mm;
}

/* Session metadata grid */
.session-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4mm 8mm;
    margin-bottom: 6mm;
    font-size: 11px;
}

.meta-item {
    display: flex;
    gap: 4mm;
}

.meta-label {
    font-weight: 600;
    color: var(--muted);
    min-width: 35mm;
}

.meta-value {
    font-weight: 400;
}

/* Attendance table */
.attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 8mm;
    font-size: 10px;
}

.attendance-table thead th {
    background-color: #2c3e50;
    color: white;
    font-weight: 600;
    padding: 4px 6px;
    text-align: left;
    border-bottom: 2px solid #34495e;
}

.attendance-table tbody td {
    padding: 3px 6px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.attendance-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

.attendance-table .col-party {
    width: 20%;
}

.attendance-table .col-name {
    width: 35%;
}

.attendance-table .col-role {
    width: 30%;
}

.attendance-table .col-proxy {
    width: 15%;
    text-align: center;
}

.backup-name {
    color: var(--muted);
    font-size: 9px;
    display: block;
    margin-top: 2px;
}

/* Other attendees */
.other-attendees {
    font-size: 10px;
    margin-bottom: 6mm;
    padding: 4mm;
    background-color: #f8f9fa;
    border-left: 3px solid var(--brand);
}

.other-attendees strong {
    color: var(--brand);
}

/* Session opener */
.session-opener {
    text-align: center;
    font-style: italic;
    color: var(--muted);
    margin: 6mm 0;
    padding: 4mm 0;
    border-top: 1px dashed var(--rule);
    border-bottom: 1px dashed var(--rule);
}

/* Agenda items */
.agenda-item {
    margin-bottom: 8mm;
    page-break-inside: avoid;
}

.agenda-item-header {
    background-color: #f8f9fa;
    border-left: 4px solid var(--brand);
    padding: 3mm 4mm;
    margin-bottom: 3mm;
}

.agenda-item-code {
    font-weight: 700;
    font-size: 12px;
    color: var(--brand);
}

.agenda-item-title {
    font-weight: 600;
    font-size: 11px;
    color: var(--ink);
    margin-left: 8mm;
}

.agenda-item-type {
    font-size: 9px;
    color: var(--muted);
    font-style: italic;
    margin-left: 8mm;
}

.agenda-item-body {
    padding: 0 4mm;
}

.item-field {
    margin-bottom: 3mm;
}

.item-field-label {
    font-weight: 600;
    color: var(--muted);
    font-size: 10px;
    margin-bottom: 1mm;
}

.item-field-content {
    font-size: 10px;
    line-height: 1.4;
}

/* Voting results */
.vote-summary {
    background-color: #ecf0f1;
    padding: 3mm 4mm;
    border-radius: 2px;
    margin: 3mm 0;
}

.vote-counts {
    display: flex;
    gap: 6mm;
    font-size: 10px;
    margin-bottom: 2mm;
}

.vote-count {
    display: flex;
    align-items: center;
    gap: 2mm;
}

.vote-count-label {
    font-weight: 600;
    color: var(--muted);
}

.vote-count-value {
    font-weight: 700;
    font-size: 12px;
}

.vote-result {
    font-weight: 700;
    font-size: 11px;
    margin-top: 2mm;
}

.vote-result.passed {
    color: #27ae60;
}

.vote-result.rejected {
    color: #e74c3c;
}

/* Named votes table */
.named-votes-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 2mm;
    font-size: 9px;
}

.named-votes-table th,
.named-votes-table td {
    padding: 2px 4px;
    border: 1px solid #dee2e6;
    text-align: left;
}

.named-votes-table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

/* Election result */
.election-result {
    background-color: #e8f5e9;
    border-left: 3px solid #27ae60;
    padding: 3mm 4mm;
    margin: 3mm 0;
}

.election-result strong {
    color: #27ae60;
}

/* Dividers */
.item-divider {
    border: none;
    border-top: 1px solid #dee2e6;
    margin: 6mm 0;
}
{% endblock %}

{% block content %}
<!-- Running headers/footers -->
<div class="protocol-header">
    <strong>{% block protocol_header_text %}Protokoll der Sitzung{% endblock %}</strong> — {{ session.code }}
</div>

<div class="protocol-footer">
    <strong>{{ org.org_name_long_de }}</strong>
    {% if org.org_address %} • {{ org.org_address|striptags }}{% endif %}
</div>

<!-- Page 1: Masthead + Attendance -->
<div class="protocol-masthead">
    <h1>{% block protocol_title %}Protokoll{% endblock %}</h1>
    <div class="subtitle">{% block protocol_subtitle %}Sitzung der HV am {{ session.session_date|date:"d.m.Y" }}{% endblock %}</div>
</div>

<div class="session-meta">
    <div class="meta-item">
        <span class="meta-label">{% trans "Beginn" %}:</span>
        <span class="meta-value">{% block session_start %}{{ session.session_time|time:"H:i" }} Uhr{% endblock %}</span>
    </div>
    <div class="meta-item">
        <span class="meta-label">{% trans "Ort" %}:</span>
        <span class="meta-value">{{ session.location|default:"—" }}</span>
    </div>
    <div class="meta-item">
        <span class="meta-label">{% trans "Abhaltungsart" %}:</span>
        <span class="meta-value">{% block session_format %}Präsenz{% endblock %}</span>
    </div>
    {% block extra_session_meta %}{% endblock %}
</div>

<table class="attendance-table">
    <thead>
        <tr>
            <th class="col-party">{% trans "Ww Gruppe" %}</th>
            <th class="col-name">{% trans "Mandatar*in" %}</th>
            <th class="col-role">{% trans "Funktion" %}</th>
            <th class="col-proxy">{% trans "Stimmübertragung" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for mandate in session.attendees.all %}
        <tr>
            <td>{{ mandate.party|default:"—" }}</td>
            <td>
                <strong>{{ mandate.person_role.person.first_name }} {{ mandate.person_role.person.last_name }}</strong>
                {% if mandate.backup_person_role %}
                    <span class="backup-name">{{ mandate.backup_person_role.person.first_name }} {{ mandate.backup_person_role.person.last_name }}</span>
                {% elif mandate.backup_person_text %}
                    <span class="backup-name">{{ mandate.backup_person_text }}</span>
                {% endif %}
            </td>
            <td>{{ mandate.get_officer_role_display }}</td>
            <td>—</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if session.other_attendees %}
<div class="other-attendees">
    <strong>{% trans "Weitere Anwesende" %}:</strong> {{ session.other_attendees }}
</div>
{% endif %}

<div class="session-opener">
    — {% block session_opener %}Die Sitzung wird um {{ session.session_time|time:"H:i" }} Uhr eröffnet{% endblock %} —
</div>

<!-- Agenda items -->
{% block protocol_content %}
{% for item in items %}
    {% if item.kind != 'PROC' or item.title != 'Eröffnung' %}
    <div class="agenda-item">
        <div class="agenda-item-header">
            <span class="agenda-item-code">{{ item.order }}. {{ item.item_code }}</span>
            <span class="agenda-item-title">{{ item.title }}</span>
            <br>
            <span class="agenda-item-type">{{ item.get_kind_display }}</span>
        </div>

        <div class="agenda-item-body">
            {% if item.kind == 'PROC' %}
                <div class="item-field-content">
                    {{ item.content|linebreaks }}
                </div>

            {% elif item.kind == 'RES' %}
                {% if item.subject %}
                <div class="item-field">
                    <div class="item-field-label">{% trans "Gegenstand" %}:</div>
                    <div class="item-field-content">{{ item.subject|safe }}</div>
                </div>
                {% endif %}

                {% if item.discussion %}
                <div class="item-field">
                    <div class="item-field-label">{% trans "Diskussion" %}:</div>
                    <div class="item-field-content">{{ item.discussion|safe }}</div>
                </div>
                {% endif %}

                {% if item.voting_mode != 'NONE' %}
                <div class="vote-summary">
                    <div class="vote-counts">
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Dafür" %}:</span>
                            <span class="vote-count-value">{{ item.votes_for }}</span>
                        </div>
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Dagegen" %}:</span>
                            <span class="vote-count-value">{{ item.votes_against }}</span>
                        </div>
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Enthaltungen" %}:</span>
                            <span class="vote-count-value">{{ item.votes_abstain }}</span>
                        </div>
                    </div>

                    {% if item.voting_mode == 'NAMED' %}
                    <table class="named-votes-table">
                        <thead>
                            <tr>
                                <th>{% trans "Mandatar*in" %}</th>
                                <th>{% trans "Stimme" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vote in item.named_votes.all %}
                            <tr>
                                <td>{{ vote.mandate.person_role.person }}</td>
                                <td>{{ vote.get_vote_display }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    <div class="vote-result {% if item.passed %}passed{% else %}rejected{% endif %}">
                        {% if item.passed %}
                            ✓ {% trans "ANGENOMMEN" %}
                        {% else %}
                            ✗ {% trans "ABGELEHNT" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if item.outcome %}
                <div class="item-field">
                    <div class="item-field-label">{% trans "Beschluss" %}:</div>
                    <div class="item-field-content">{{ item.outcome|safe }}</div>
                </div>
                {% endif %}

            {% elif item.kind == 'ELEC' %}
                {% if item.subject %}
                <div class="item-field">
                    <div class="item-field-label">{% trans "Gegenstand" %}:</div>
                    <div class="item-field-content">{{ item.subject|safe }}</div>
                </div>
                {% endif %}

                {% if item.elected_person_role %}
                <div class="election-result">
                    <strong>{% trans "Gewählt" %}:</strong>
                    {{ item.elected_person_role.person }} → {{ item.elected_person_role.role.name }}
                </div>
                {% endif %}

                {% if item.voting_mode != 'NONE' %}
                <div class="vote-summary">
                    <div class="vote-counts">
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Dafür" %}:</span>
                            <span class="vote-count-value">{{ item.votes_for }}</span>
                        </div>
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Dagegen" %}:</span>
                            <span class="vote-count-value">{{ item.votes_against }}</span>
                        </div>
                        <div class="vote-count">
                            <span class="vote-count-label">{% trans "Enthaltungen" %}:</span>
                            <span class="vote-count-value">{{ item.votes_abstain }}</span>
                        </div>
                    </div>

                    <div class="vote-result {% if item.passed %}passed{% else %}rejected{% endif %}">
                        {% if item.passed %}
                            ✓ {% trans "GEWÄHLT" %}
                        {% else %}
                            ✗ {% trans "NICHT GEWÄHLT" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if item.outcome %}
                <div class="item-field">
                    <div class="item-field-label">{% trans "Anmerkung" %}:</div>
                    <div class="item-field-content">{{ item.outcome|safe }}</div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if not forloop.last %}
    <hr class="item-divider">
    {% endif %}
    {% endif %}
{% endfor %}
{% endblock %}

<!-- Signatures -->
<div style="margin-top: 12mm;">
    {% include '_includes/_signature_seal.html' with signatures=signatures %}
</div>

{% endblock %}